<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <title>Data Analysis Results</title>
    
     
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    
    <link rel="stylesheet" href="{{url_for( 'static', path='css/results.css')}}">
    <link rel="stylesheet" href="{{url_for( 'static', path='css/chat.css')}}">
    
  </head>

  <body class="p-8">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-8">
        <div class="flex items-center justify-center mb-2">
          <i class="fas fa-chart-line text-indigo-600 text-2xl mr-2"></i>
          <h1 class="text-2xl font-semibold gradient-text">
            Data Analysis Results
          </h1>
        </div>
        <p class="text-gray-500 text-sm">
          Comprehensive analysis of your uploaded dataset
        </p>
      </div>




      <div class="card mb-6 p-6">
        <div class="flex items-center mb-4">
          <div class="section-icon">
            <i class="fas fa-file-alt"></i>
          </div>
          <h2 class="text-lg font-semibold text-gray-800">File Information</h2>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="flex items-center">
            <span class="text-gray-500 text-sm mr-2">Filename:</span>
            <span class="text-gray-800">{{ file.filename }}</span>
          </div>
          <div class="flex items-center">
            <span class="text-gray-500 text-sm mr-2">Total Rows:</span>
            <span class="text-gray-800">{{ analysis.overview.shape.rows }}</span>

          </div>
          <div class="flex items-center">
            <span class="text-gray-500 text-sm mr-2">Total Columns:</span>
            <span class="text-gray-800"
              >{{ analysis.overview.shape.columns }}</span
            >
          </div>
          <div class="flex items-center">
            <span class="text-gray-500 text-sm mr-2">Duplicate Rows:</span>
            <span class="text-gray-800"
              >{{ analysis.overview.duplicate_count }}</span
            >
          </div>
        </div>
      </div>

      <!-- VRHFIHBJEV VVFNEJBVIBJVIHVBJK VFEIOHFVJIVHNVNFNVDSVNDKDNVNKDVNDKNKDVNKVNKVKNDVKVNKNDV -->
             
     
   


    <div class="card p-6 mt-6">
  <div class="flex items-center mb-4">
    <div class="section-icon">
      <i class="fas fa-table"></i>
    </div>
    <h2 class="text-lg font-semibold text-gray-800">Data Preview</h2>
    <span class="ml-2 text-sm text-gray-500">(First 10 Rows)</span>
  </div>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          {% for key in analysis.overview.table_head[0].keys() %}
          <th class="font-medium" title="{{ key|title }}">{{ key|title }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in analysis.overview.table_head %}
        <tr>
          {% for value in row.values() %}
          <td class="text-gray-600">
            {% if value is none %}
              <span class="text-gray-400">N/A</span>
            {% elif value is number %}
              {% if value|round(0) == value %}
                {{ value|int }}
              {% else %}
                {{ value|round(2) }}
              {% endif %}
            {% else %}
              {{ value }}
            {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
    </div>
</div>

      <!-- VRHFIHBJEV VVFNEJBVIBJVIHVBJK VFEIOHFVJIVHNVNFNVDSVNDKDNVNKDVNDKNKDVNKVNKVKNDVKVNKNDV -->





        <!-- LOADING DATASET SUMMARY AND SAMPLE ROWS -->
      <p id="data-summary" hidden>{{analysis.data_summary}}</p>
      <p id="sample-rows" hidden>{{ analysis.sample_rows | tojson }}</p>








<!-- CHAT WITH DATA SECTION  -->
<section class="max-w-7xl mx-auto mt-12 mb-16 px-4">
  <h2 class="text-2xl font-bold text-center mb-6 text-blue-700">Chat</h2>
  <div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col gap-8">

    <!-- Chat history -->
    <div class="flex flex-col gap-4 max-h-96 overflow-y-auto" id="chat-history-box">
      <!-- This is where the message interaction between user and AI take place -->
    </div>
    
    


    <!-- Chat input -->
    <form class="flex items-center gap-2 mt-2" autocomplete="off" id="chat-form">
      <input
        type="text"
        class="flex-1 rounded-full border border-blue-200 focus:ring-2 focus:ring-blue-400 px-4 py-2 text-gray-800 bg-blue-50 placeholder-gray-400 transition"
        placeholder="What do you want to do with your data?"
        id="user-message"
      />
      <button
        type="submit"
        class="bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-full px-5 py-2 font-semibold shadow hover:from-blue-600 hover:to-purple-600 transition"
      >
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
    
  </div>
</section>



</div>

</body>
</html>

<script>


let chatForm = document.getElementById('chat-form');    //Form that triggers the sending of requests (chat) to the backend
let userMessage = document.getElementById('user-message');  //The message sent by the user in the frontend that's taken to the backend
let chatHistoryBox = document.getElementById('chat-history-box');   // displays the user and AI's conversation (works only on frontend)
let dataSummary = document.getElementById('data-summary')?.textContent || "";
let messageHistory = [];    // An array that tracks the conversation, for sending message context to the backend
let sampleRows = [];

// Safely parse sample rows. We parse JSON to convert it from a regular JSON string to a data structure that a program can actually unserstand. e.g from JSON to python dictionary or javascript array
try {
  sampleRows = JSON.parse(document.getElementById('sample-rows')?.textContent || "[]");
} catch (e) {
  console.error("Failed to parse sample rows:", e);
  sampleRows = [];
}

chatForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  let message = userMessage.value.trim();
  if (!message) return;

  // Add user message to chat
  chatHistoryBox.innerHTML += `
    <div class="flex justify-end">
      <div class="user-bubble mr-3">
        <span>${escapeHtml(message)}</span>
      </div>
    </div>
  `; 
  // escapeHtml() protects your chat app from being hacked via malicious HTML or scripts. Always sanitize input before injecting into innerHTML. It replaces regular HTML script symbols like '>', '"' with characters so that attackers can't alter HTML and input comes out as plain text
  userMessage.value = "";



  messageHistory.push({role: "user", content: message});
  

  // Add loading indicator
  const loadingId = 'loading-' + Date.now();
  chatHistoryBox.innerHTML += `
    <div class="flex justify-start" id="${loadingId}">
      <div class="ai-message max-w-[90%]">
        <div class="ai-content">
          <i class="fas fa-spinner fa-spin"></i> Thinking...
        </div>
      </div>
    </div>
  `;

  // SENDING USER MESSAGE AND DATA INFORMATION TO CHAT ENDPOINT ====================================
  try {
    // Send request to backend
    const response = await fetch("/results/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        message: message,
        data_summary: dataSummary,
        message_history: messageHistory,
        sample_rows: sampleRows
      })
    });
    // SENDING USER MESSAGE AND DATA INFORMATION TO CHAT ENDPOINT ====================================
      


    // Remove loading indicator after data has hit chat endpoint
    document.getElementById(loadingId)?.remove();
    // Error handling if the sending of data has an error for any reason========================
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    // Error handling if the sending of data has an error for any reason========================

    // responseData is the variable containing the API response sent back after it has received and pprocessed a request (response)
    const responseData = await response.json();
    // The .reply in responseData.reply is the same name as what the backend returns: "reply": f"AI service error: {str(e)}"
    const AIReply = responseData.reply || "Sorry, I couldn't process your request.";
    const codeResult = responseData.code_result || []
    
    // Add AI response to chat
    chatHistoryBox.innerHTML += `
      <div class="flex justify-start">
        <div class="ai-message max-w-[90%]">
          <div class="ai-content">${AIReply}</div>
        </div>
      </div>
    `;
      


    messageHistory.push({role: "assistant", content: AIReply});
    
    console.log(messageHistory)

  } catch (error) {                         // The catch statement gets any error that shows up and 
    console.error("Chat error:", error);
    
    // Remove loading indicator
    document.getElementById(loadingId)?.remove();
    
    // Add error message
    chatHistoryBox.innerHTML += `
      <div class="flex justify-start">
        <div class="ai-message max-w-[90%] bg-red-50 border-red-200">
          <div class="ai-content text-red-700">
            <i class="fas fa-exclamation-triangle"></i> 
            Error: ${error.message}. Please try again.
          </div>
        </div>
      </div>
    `;
  }

  // Scroll to bottom
  chatHistoryBox.scrollTop = chatHistoryBox.scrollHeight;
});

// Helper function to escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>





























