<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <title>Data Analysis Results</title>
    
     
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    
    <link rel="stylesheet" href="{{url_for( 'static', path='css/results.css')}}">
    <link rel="stylesheet" href="{{url_for( 'static', path='css/chat.css')}}">
    <link rel="stylesheet" href="{{url_for( 'static', path='js/results.js')}}">
    
  </head>

  <body class="p-8">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-8">
        <div class="flex items-center justify-center mb-2">
          <i class="fas fa-chart-line text-indigo-600 text-2xl mr-2"></i>
          <h1 class="text-2xl font-semibold gradient-text">
            Data Analysis Results
          </h1>
        </div>
        <p class="text-gray-500 text-sm">
          Comprehensive analysis of your uploaded dataset
        </p>
      </div>




      <div class="card mb-6 p-6">
        <div class="flex items-center mb-4">
          <div class="section-icon">
            <i class="fas fa-file-alt"></i>
          </div>
          <h2 class="text-lg font-semibold text-gray-800">File Information</h2>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="flex items-center">
            <span class="text-gray-500 text-sm mr-2">Filename:</span>
            <span class="text-gray-800">{{ file.filename }}</span>
          </div>
          <div class="flex items-center">
            <span class="text-gray-500 text-sm mr-2">Total Rows:</span>
            <span class="text-gray-800">{{ analysis.overview.shape.rows }}</span>

          </div>
          <div class="flex items-center">
            <span class="text-gray-500 text-sm mr-2">Total Columns:</span>
            <span class="text-gray-800"
              >{{ analysis.overview.shape.columns }}</span
            >
          </div>
          <div class="flex items-center">
            <span class="text-gray-500 text-sm mr-2">Duplicate Rows:</span>
            <span class="text-gray-800"
              >{{ analysis.overview.duplicate_count }}</span
            >
          </div>
        </div>
      </div>

        <!-- LOADING DATASET SUMMARY AND SAMPLE ROWS -->
      <p id="data-summary" hidden>{{analysis.data_summary}}</p>









<!-- CHAT WITH DATA SECTION  -->
<section class="max-w-7xl mx-auto mt-12 mb-16 px-4">
  <h2 class="text-2xl font-bold text-center mb-6 text-blue-700">Chat</h2>
  <div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col gap-8">
    <!-- Chat history -->
    <div class="flex flex-col gap-4 max-h-96 overflow-y-auto" id="chat-history-box">
      <!-- This is where the message interaction between user and AI take place -->
    </div>
    
    


    <!-- Chat input -->
    <form class="flex items-center gap-2 mt-2" autocomplete="off" method="post" id="chat-form">
      <input
        type="text"
        class="flex-1 rounded-full border border-blue-200 focus:ring-2 focus:ring-blue-400 px-4 py-2 text-gray-800 bg-blue-50 placeholder-gray-400 transition"
        placeholder="What do you want to do with your data?"
        id="user-message"
      />
      <button
        type="submit"
        class="bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-full px-5 py-2 font-semibold shadow hover:from-blue-600 hover:to-purple-600 transition"
      >
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
    <div class="text-xs text-gray-400 text-center mt-2">Live chat coming soon!</div>
  </div>
</section>





</div>
</body>
</html>


<script>
  const chatForm = document.getElementById('chat-form');
  const userMessage = document.getElementById('user-message');
  const chatHistoryBox = document.getElementById('chat-history-box');
  const dataSummary = document.getElementById('data-summary')?.textContent || "";
  let messageHistory = []    //  ===================================================

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    let message = userMessage.value.trim();
    if (!message) return;

    chatHistoryBox.innerHTML += `
    <div class="flex justify-end">
      <div class="user-bubble mr-3">
        <span>${message}</span>
      </div>
    </div>
  `;
    userMessage.value = ""
    messageHistory.push({role : "user", content : message})   //  ==================================================



    // Sending user message and data summary to backend
    let response = await fetch("/results/chat", {
      method : "POST",
      headers : {"Content-Type" : "application/json"},
      body : JSON.stringify({
        message: message,
        data_summary: dataSummary,
        message_history : messageHistory,   //  ===============================================
        
      })
    })
    let response_data = await response.json();
    
    

    
    let AIReply = response_data.reply;
    chatHistoryBox.innerHTML += `
    <div class="flex justify-start">
      <div class="ai-message max-w-[90%]">
        <div class="ai-content">${AIReply}</div>
      </div>
    </div>`;

    messageHistory.push({role : "assistant", content : AIReply})    //  ===============================================


    chatHistoryBox.scrollTop = chatHistoryBox.scrollHeight; 

    
  });
</script>



























<!--       
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="wrappy">
        <div class="card p-6">
          <div class="flex items-center mb-4">
            <div class="section-icon">
              <i class="fas fa-table"></i>
            </div>
            <h2 class="text-lg font-semibold text-gray-800">
              Column Information
            </h2>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Column Name</th>
                  <th>Data Type</th>
                  <th>Unique Values</th>
                </tr>
              </thead>
              <tbody>
                {% for col in analysis.overview.column_data_types %} {% set
                unique =
                analysis.overview.unique_values|selectattr("column_name",
                "equalto", col.column_name)|first %}
                <tr>
                  <td>{{ col.column_name }}</td>
                  <td>{{ col.data_type }}</td>
                  <td>{{ unique.unique_values }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>




        <div class="card p-6">
          <div class="flex items-center mb-4">
            <div class="section-icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="text-lg font-semibold text-gray-800">
              Missing Data Analysis
            </h2>
          </div>
          {% if analysis.missing_data.missing_data is defined %}
          {% if analysis.missing_data.missing_data is string %}
          <div class="status-badge status-success" style="text-align: center; font-size: 1rem;">
            {{ analysis.missing_data.missing_data }}
          </div>
          {% else %}
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Column</th>
                  <th>Missing Count</th>
                  <th>Missing %</th>
                </tr>
              </thead>
              <tbody>
                {% for item in analysis.missing_data.missing_data %}
                <tr>
                  <td>{{ item.column }}</td>
                  <td>{{ item.missing_count }}</td>
                  <td>
                    <span
                      class="status-badge {% if item.missing_percentage > 20 %}status-error{% elif item.missing_percentage > 5 %}status-warning{% else %}status-success{% endif %}"
                    >
                      {{ item.missing_percentage }}%
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
          {% endif %}
        </div>
      </div>



      

      {% if analysis.overview.descriptive_stats %}
<div class="card p-6 mt-6">
  <div class="flex items-center mb-4">
    <div class="section-icon">
      <i class="fas fa-calculator"></i>
    </div>
    <h2 class="text-lg font-semibold text-gray-800">
      Descriptive Statistics
    </h2>
  </div>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th class="font-medium sticky-col first-col">Metric</th>
          {% for column in analysis.overview.descriptive_stats.keys() %}
          <th class="font-medium">{{ column }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for stat in ['count', 'mean', 'std', 'min', '25%', '50%',
        '75%', 'max'] %}
        <tr>
          <td class="font-medium text-gray-700 sticky-col first-col">
            {% if stat == 'std' %} Standard Deviation {% elif stat ==
            'min' %} Minimum {% elif stat == 'max' %} Maximum {% elif stat
            == '25%' %} 25th Percentile {% elif stat == '50%' %} Median {%
            elif stat == '75%' %} 75th Percentile {% else %} {{ stat|title
            }} {% endif %}
          </td>
          {% for column in analysis.overview.descriptive_stats.keys() %}
          <td class="text-gray-600">
            {% set value =
            analysis.overview.descriptive_stats[column][stat] %} {% if
            value is not none %} {% if stat in ['count'] %} {{ value|int
            }} {% else %} {{ value|round(2) }} {% endif %} {% else %}
            <span class="text-gray-400">N/A</span>
            {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}


   



<div class="card p-6 mt-6">
  <div class="flex items-center mb-4">
    <div class="section-icon">
      <i class="fas fa-table"></i>
    </div>
    <h2 class="text-lg font-semibold text-gray-800">Data Preview</h2>
    <span class="ml-2 text-sm text-gray-500">(First 10 Rows)</span>
  </div>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          {% for key in analysis.overview.table_head[0].keys() %}
          <th class="font-medium" title="{{ key|title }}">{{ key|title }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in analysis.overview.table_head %}
        <tr>
          {% for value in row.values() %}
          <td class="text-gray-600">
            {% if value is none %}
              <span class="text-gray-400">N/A</span>
            {% elif value is number %}
              {% if value|round(0) == value %}
                {{ value|int }}
              {% else %}
                {{ value|round(2) }}
              {% endif %}
            {% else %}
              {{ value }}
            {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
</div> -->
